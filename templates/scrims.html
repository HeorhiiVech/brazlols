{% extends "base.html" %}

{% block title %}Scrim Statistics{% endblock %}

{% block content %}
    <style>
        /* –§–æ–Ω –≤—Å–µ–π —Å–∫—Ä—ã—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ */
        .details-row {
            background-color: #2a2a2a;
        }
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –±–ª–æ–∫–æ–≤ –¥–µ—Ç–∞–ª–µ–π */
        .match-details-container {
            padding: 15px;
            display: flex;
            justify-content: space-around;
            gap: 20px;
            border-bottom: 2px solid #444; /* –¢–µ–º–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
            color: #eee; /* –°–≤–µ—Ç–ª—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
        }
        /* –ë–ª–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã */
        .team-details {
            flex: 1;
            background: #333; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω –±–ª–æ–∫–∞ */
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω–∞—è —Ç–µ–Ω—å */
        }
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–∞–Ω–¥—ã –≤ –¥–µ—Ç–∞–ª—è—Ö */
        .team-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444; /* –¢–µ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
            color: #eee; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        }
        
        /* –°—Ç—Ä–æ–∫–∞ –∏–≥—Ä–æ–∫–∞ */
        .player-detail-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444; /* –¢–µ–º–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏ */
        }
        .player-detail-row:last-child { border-bottom: none; }
        
        .pd-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .pd-name { font-weight: 500; font-size: 0.95em; color: #eee; }
        .pd-champ-name { color: #aaa; font-size: 0.85em; margin-left: 5px;} /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π –¥–ª—è –∏–º–µ–Ω–∏ —á–µ–º–ø–∏–æ–Ω–∞ */
        .pd-kda { font-family: monospace; font-weight: bold; color: #eee; min-width: 60px; text-align: right;}
        
        /* –¶–µ–Ω—Ç—Ä —Å–æ —Å—á–µ—Ç–æ–º */
        .score-summary {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        /* –¶–≤–µ—Ç–∞ —Å—á–µ—Ç–∞ –Ω–µ–º–Ω–æ–≥–æ –æ—Å–≤–µ—Ç–ª–µ–Ω—ã –¥–ª—è —Ç–µ–º–Ω–æ–≥–æ —Ñ–æ–Ω–∞ */
        .score-blue { color: #4a90e2; }
        .score-red { color: #e74c3c; }

        /* –ö–Ω–æ–ø–∫–∞ Show/Hide */
        .btn-details {
            background: none;
            border: 1px solid #555;
            color: #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-details:hover { background-color: #444; color: #fff; }
    </style>

    <div class="header-controls">
        <h1>Scrim Statistics</h1>
        <div class="controls">
            <form action="{{ url_for('update_scrims_route', time_filter=selected_time_filter, side_filter=selected_side_filter) }}" method="post">
                 {# –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ action, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è #}
                <button type="submit" class="button button-update">Update Scrims (Dont click)</button>
            </form>
            <form method="get" class="filter-form">
                 {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –≤—Ä–µ–º–µ–Ω–∏ #}
                 <input type="hidden" name="side_filter" value="{{ selected_side_filter }}">
                <label for="time_filter">Filter:</label>
                <select name="time_filter" id="time_filter" onchange="this.form.submit()">
                    {% for filter_option in time_filters %}
                        <option value="{{ filter_option }}" {% if filter_option == selected_time_filter %}selected{% endif %}>
                            {{ filter_option }}
                        </option>
                    {% endfor %}
                </select>
                <noscript><button type="submit" class="button">Apply Filter</button></noscript>
            </form>
        </div>
    </div>

    <hr>

    <h2>Overall Statistics ({{ selected_time_filter }})</h2>
    {% if overall_stats and overall_stats.total_games > 0 %}
        <div class="overall-stats-container">
            <div class="stat-card"> {# Total card –±–µ–∑ –¥–æ–ø. –∫–ª–∞—Å—Å–∞ #}
                <h3>Total</h3>
                <p class="stat-value">{{ overall_stats.total_games }}</p>
                <p class="stat-label">Games</p>
                {% set total_wr = (overall_stats.blue_wins + overall_stats.red_wins) / overall_stats.total_games * 100 if overall_stats.total_games else 0 %}
                <p class="stat-sublabel {{ 'stat-positive' if total_wr >= 50 else 'stat-negative' }}">
                   {{ "%.1f"|format(total_wr) }}% WR
                </p>
                 <small>({{ overall_stats.blue_wins + overall_stats.red_wins }}W - {{ overall_stats.blue_losses + overall_stats.red_losses }}L)</small>
            </div>
             {# –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã stat-card-blue –∏ stat-card-red #}
            <div class="stat-card stat-card-blue">
                <h3>Blue Side</h3>
                 {% set blue_games = overall_stats.blue_wins + overall_stats.blue_losses %}
                 <p class="stat-value">{{ blue_games }}</p>
                 <p class="stat-label">Games</p>
                 {% set blue_wr = overall_stats.blue_wins / blue_games * 100 if blue_games else 0 %}
                <p class="stat-sublabel {{ 'stat-positive' if blue_wr >= 50 else 'stat-negative' }}">
                    {{ "%.1f"|format(blue_wr) }}% WR
                </p>
                 <small>({{ overall_stats.blue_wins }}W - {{ overall_stats.blue_losses }}L)</small>
            </div>
            <div class="stat-card stat-card-red">
                <h3>Red Side</h3>
                 {% set red_games = overall_stats.red_wins + overall_stats.red_losses %}
                 <p class="stat-value">{{ red_games }}</p>
                 <p class="stat-label">Games</p>
                {% set red_wr = overall_stats.red_wins / red_games * 100 if red_games else 0 %}
                <p class="stat-sublabel {{ 'stat-positive' if red_wr >= 50 else 'stat-negative' }}">
                    {{ "%.1f"|format(red_wr) }}% WR
                </p>
                 <small>({{ overall_stats.red_wins }}W - {{ overall_stats.red_losses }}L)</small>
            </div>
        </div>
    {% else %}
        <p class="notice">No overall statistics available for this period.</p>
    {% endif %}

    <hr>

    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <h2>Player Champion Stats ({{ selected_time_filter }})</h2>
        {# –ù–û–í–´–ï –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ç–æ—Ä–æ–Ω–µ #}
        <div class="side-filter-controls">
            <a href="{{ url_for('scrims', time_filter=selected_time_filter, side_filter='all') }}"
               class="button {% if selected_side_filter == 'all' %}active{% endif %}">All</a>
            <a href="{{ url_for('scrims', time_filter=selected_time_filter, side_filter='blue') }}"
               class="button {% if selected_side_filter == 'blue' %}active{% endif %}">Blue Side</a>
            <a href="{{ url_for('scrims', time_filter=selected_time_filter, side_filter='red') }}"
               class="button {% if selected_side_filter == 'red' %}active{% endif %}">Red Side</a>
        </div>
    </div>

    {% if player_stats %}
    <div class="player-stats-grid">
        {% for player_name, champs in player_stats.items() %}
            {% if champs %} {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ #}
            <div class="player-column">
                <h3>{{ player_name }}</h3>
                <div class="table-responsive">
                    {# –î–æ–±–∞–≤–ª—è–µ–º id –∫ —Ç–∞–±–ª–∏—Ü–µ –¥–ª—è JS #}
                    <table class="player-champ-table sortable-table" id="table-{{ player_name }}">
                        <thead>
                            <tr>
                                {# –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∏ data-sort-type –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –¥–ª—è JS #}
                                <th>Icon</th>
                                <th class="sortable-header" data-sort-col="1" data-sort-type="number">G</th>
                                <th class="sortable-header" data-sort-col="2" data-sort-type="number">WR%</th>
                                <th class="sortable-header" data-sort-col="3" data-sort-type="number">KDA</th>
                                <th class="sortable-header" data-sort-col="4" data-sort-type="number">Dmg</th>
                                <th class="sortable-header" data-sort-col="5" data-sort-type="number">CS</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for champ_name, stats in champs.items() %}
                             <tr>
                                <td>{{ stats.icon_html | safe }}</td>
                                <td>{{ stats.games }}</td>
                                <td data-sort-value="{{ stats.win_rate }}" class="
                                    {% if stats.win_rate >= 60 %}wr-high
                                    {% elif stats.win_rate <= 45 %}wr-low
                                    {% else %}wr-mid{% endif %}
                                ">{{ "%.1f"|format(stats.win_rate) }}</td>
                                <td data-sort-value="{{ stats.kda }}">{{ "%.1f"|format(stats.kda) }}</td>
                                <td data-sort-value="{{ stats.avg_dmg }}">{{ stats.avg_dmg }}</td>
                                <td data-sort-value="{{ stats.avg_cs }}">{{ "%.1f"|format(stats.avg_cs) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% else %}
        <p class="notice">No player statistics available for {{ selected_side_filter if selected_side_filter != 'all' else 'this period'}}{% if selected_side_filter != 'all' %} side{% endif %}.</p>
    {% endif %}


    <hr>

   <h2>Game History ({{ selected_time_filter }})</h2>
    {% if history %}
        <div class="table-responsive">
        <table class="scrims-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Patch</th>
                    <th>Blue Team</th>
                    <th>B Bans</th>
                    <th>B Picks</th>
                    <th>R Picks</th>
                    <th>R Bans</th>
                    <th>Red Team</th>
                    <th>Result</th>
                    <th>Duration</th>
                    <th>Details</th> </tr>
            </thead>
            <tbody>
                {% for game in history %}
                <tr>
                    <td class="col-date">{{ game['Date'] }}</td>
                    <td class="col-patch">{{ game['Patch'] }}</td>
                    <td class="col-team">{{ game['Blue_Team_Name'] }}</td>
                    <td class="col-picks-bans">{{ game['B_Bans_HTML'] | safe }}</td>
                    <td class="col-picks-bans">{{ game['B_Picks_HTML'] | safe }}</td>
                    <td class="col-picks-bans">{{ game['R_Picks_HTML'] | safe }}</td>
                    <td class="col-picks-bans">{{ game['R_Bans_HTML'] | safe }}</td>
                    <td class="col-team">{{ game['Red_Team_Name'] }}</td>
                    <td class="col-result result-{{ game['Result'] | lower }}">{{ game['Result'] }}</td>
                    <td class="col-duration">{{ game['Duration'] }}</td>
                    <td>
                        <button class="btn-details" onclick="toggleDetails('details-{{ game.Game_ID }}')">
                            Show
                        </button>
                    </td>
                </tr>
                
                <tr id="details-{{ game.Game_ID }}" class="details-row" style="display: none;">
                    <td colspan="11">
                        <div class="match-details-container" style="padding: 20px; display: flex; flex-direction: column; gap: 15px; background: #0d1117;">
                            
                            <div style="display: flex; justify-content: space-around; gap: 20px; align-items: flex-start;">
                                
                                <div class="team-details blue-side" style="flex: 1; background: #1a2333; padding: 15px; border-radius: 8px; border-left: 5px solid #4a90e2; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                                    <div class="team-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333;">
                                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                            <span style="color: #4a90e2; font-weight: bold; font-size: 1.2em;">{{ game.Blue_Team_Name }}</span>
                                            <div class="toggle-btns" style="margin-top: 5px; display: flex; gap: 5px;">
                                                <button onclick="toggleAssets(this, 'items')" class="asset-btn active-blue">ITEMS</button>
                                                <button onclick="toggleAssets(this, 'runes')" class="asset-btn">RUNES</button>
                                                <button onclick="toggleAssets(this, 'stats')" class="asset-btn">STATS</button>
                                            </div>
                                        </div>
                                        <span style="background: #4a90e2; color: white; padding: 2px 10px; border-radius: 4px; font-size: 1.3em; font-weight: 800;">{{ game.details.blue_total_kills }}</span>
                                    </div>
                                    
                                    <div class="players-list">
                                        {% for p in game.details.blue_players %}
                                        <div class="player-detail-row" style="display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #2d333b; gap: 10px;">
                                            <div style="display: flex; align-items: center; width: 130px; flex-shrink: 0;">
                                                <div style="width: 24px; height: 24px; flex-shrink: 0; margin-right: 8px;">{{ p.icon_html | safe }}</div>
                                                <span style="font-size: 0.8em; color: #fff;">{{ p.name }}</span>
                                            </div>

                                            <div class="player-assets-wrapper" style="display: flex; gap: 3px; flex-grow: 1; justify-content: center;">
                                                <div class="items-container asset-box">
                                                    {% if p.items_list %}
                                                        {% set items = p.items_list.split(',') if p.items_list is string else p.items_list %}
                                                        {% for item_id in items %}
                                                            {% if item_id|string != "0" and item_id|string != "" %}
                                                                <img src="https://ddragon.leagueoflegends.com/cdn/16.1.1/img/item/{{ item_id }}.png" width="20" height="20" style="border-radius: 2px;">
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <div class="runes-container asset-box" style="display: none;">{{ p.rune_html | safe }}</div>
                                                <div class="stats-container asset-box" style="display: none; width: 100%; max-width: 100px;">
                                                    <div style="height: 4px; background: #111; border-radius: 2px; overflow: hidden;">
                                                        <div style="width: {{ (p.dmg / (p.max_dmg if p.max_dmg > 0 else 1) * 100)|round }}%; height: 100%; background: #4a90e2;"></div>
                                                    </div>
                                                    <div style="font-size: 0.7em; color: #888; text-align: center;">{{ p.dmg }} dmg</div>
                                                </div>
                                            </div>
                                            <div style="width: 70px; text-align: right; font-family: monospace; font-size: 0.85em;">{{ p.k }}/{{ p.d }}/{{ p.a }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <div class="events-label" style="margin-top: 15px; font-size: 0.75em; color: #4a90e2; font-weight: bold; text-transform: uppercase;">Team Events</div>
                                    <div class="events-container event-list-scrollable" style="margin-top: 5px; height: 180px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 4px; padding: 8px; border: 1px solid #2d333b;">
                                        {% if game.details.blue_events %}
                                            {% for event in game.details.blue_events %}
                                            <div class="event-item" style="font-size: 0.75em; margin-bottom: 4px; border-bottom: 1px solid #222; color: #ccc;">
                                                <span style="color: #888;">[{{ event.time }}]</span> <strong>{{ event.text }}</strong>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div style="color: #555; text-align: center; font-size: 0.8em; margin-top: 70px;">No events recorded</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="replay-main-container" style="flex: 0 0 420px; background: #1a1a1a; padding: 15px; border-radius: 10px; align-self: stretch; display: flex; flex-direction: column; justify-content: center;">
                                    <div class="map-container" id="map-{{ game.Game_ID }}" style="position: relative; width: 400px; height: 400px; background: url('/static/images/minimap.png') no-repeat center; background-size: contain; border: 2px solid #444; overflow: hidden; border-radius: 4px;"></div>
                                    <div class="player-controls" style="margin-top: 15px; text-align: center;">
                                        <input type="range" id="slider-{{ game.Game_ID }}" style="width: 100%;" min="0" value="0" step="1" oninput="seekGame('{{ game.Game_ID }}', this.value)">
                                        <div style="display: flex; justify-content: space-between; color: #ccc; font-size: 0.8em; margin: 5px 0; font-family: monospace;">
                                            <span id="time-current-{{ game.Game_ID }}">00:00</span>
                                            <span id="time-total-{{ game.Game_ID }}">00:00</span>
                                        </div>
                                        <button 
                                            id="play-btn-{{ game.Game_ID }}" 
                                            class="play-btn" 
                                            onclick="togglePlay(this)" 
                                            style="width: 140px; padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            Play
                                        </button>
                                    </div>
                                </div>

                                <div class="team-details red-side" style="flex: 1; background: #331a1a; padding: 15px; border-radius: 8px; border-right: 5px solid #e24a4a; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                                    <div class="team-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333;">
                                        <span style="background: #e24a4a; color: white; padding: 2px 10px; border-radius: 4px; font-size: 1.3em; font-weight: 800;">{{ game.details.red_total_kills }}</span>
                                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                            <span style="color: #e24a4a; font-weight: bold; font-size: 1.2em;">{{ game.Red_Team_Name }}</span>
                                            <div class="toggle-btns" style="margin-top: 5px; display: flex; gap: 5px;">
                                                <button onclick="toggleAssets(this, 'items')" class="asset-btn active-red">ITEMS</button>
                                                <button onclick="toggleAssets(this, 'runes')" class="asset-btn">RUNES</button>
                                                <button onclick="toggleAssets(this, 'stats')" class="asset-btn">STATS</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="players-list">
                                        {% for p in game.details.red_players %}
                                        <div class="player-detail-row" style="display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #3d2a2a; gap: 10px;">
                                            <div style="display: flex; align-items: center; width: 130px; flex-shrink: 0;">
                                                <div style="width: 24px; height: 24px; flex-shrink: 0; margin-right: 8px;">{{ p.icon_html | safe }}</div>
                                                <span style="font-size: 0.8em; color: #fff;">{{ p.name }}</span>
                                            </div>
                                            <div class="player-assets-wrapper" style="display: flex; gap: 3px; flex-grow: 1; justify-content: center;">
                                                <div class="items-container asset-box">
                                                    {% if p.items_list %}
                                                        {% set items = p.items_list.split(',') if p.items_list is string else p.items_list %}
                                                        {% for item_id in items %}
                                                            {% if item_id|string != "0" and item_id|string != "" %}
                                                                <img src="https://ddragon.leagueoflegends.com/cdn/16.1.1/img/item/{{ item_id }}.png" width="20" height="20" style="border-radius: 2px;">
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <div class="runes-container asset-box" style="display: none;">{{ p.rune_html | safe }}</div>
                                                <div class="stats-container asset-box" style="display: none; width: 100%; max-width: 100px;">
                                                    <div style="height: 4px; background: #111; border-radius: 2px; overflow: hidden;">
                                                        <div style="width: {{ (p.dmg / (p.max_dmg if p.max_dmg > 0 else 1) * 100)|round }}%; height: 100%; background: #e24a4a;"></div>
                                                    </div>
                                                    <div style="font-size: 0.7em; color: #888; text-align: center;">{{ p.dmg }} dmg</div>
                                                </div>
                                            </div>
                                            <div style="width: 70px; text-align: right; font-family: monospace; font-size: 0.85em;">{{ p.k }}/{{ p.d }}/{{ p.a }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <div class="events-label" style="margin-top: 15px; font-size: 0.75em; color: #e24a4a; font-weight: bold; text-transform: uppercase; text-align: right;">Team Events</div>
                                    <div class="events-container event-list-scrollable" style="margin-top: 5px; height: 180px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 4px; padding: 8px; border: 1px solid #3d2a2a;">
                                        {% if game.details.red_events %}
                                            {% for event in game.details.red_events %}
                                            <div class="event-item" style="font-size: 0.75em; margin-bottom: 4px; border-bottom: 1px solid #222; color: #ccc;">
                                                <span style="color: #888;">[{{ event.time }}]</span> <strong>{{ event.text }}</strong>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div style="color: #555; text-align: center; font-size: 0.8em; margin-top: 70px;">No events recorded</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>

                <style>
                    .asset-btn { background: #333; border: 1px solid #555; color: #888; border-radius: 3px; cursor: pointer; font-size: 0.7em; padding: 2px 6px; }
                    .active-blue { background: #4a90e2 !important; color: white !important; border-color: #4a90e2 !important; }
                    .active-red { background: #e24a4a !important; color: white !important; border-color: #e24a4a !important; }
                </style>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="notice">No game history available for this period.</p>
    {% endif %}
    {# --- –ù–û–í–´–ô –ë–ª–æ–∫ JavaScript –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π --- #}
  <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π
        const loadedReplays = {};

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–µ—Ç–∞–ª–µ–π
        async function toggleDetails(rowId) {
            const row = document.getElementById(rowId);
            const btn = row.previousElementSibling.querySelector('.btn-details');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å ID –∏–∑ rowId (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ 'details-9f67...')
            const gameId = rowId.replace('details-', '');
            
            console.log("Opening details for Game ID:", gameId); // –ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ –≤ –∫–æ–Ω—Å–æ–ª–∏!

            if (row.style.display === 'none') {
                row.style.display = 'table-row';
                if (btn) btn.textContent = 'Hide';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
                if (!loadedReplays[gameId]) {
                    await loadReplayData(gameId);
                }
            } else {
                row.style.display = 'none';
                if (btn) btn.textContent = 'Show';
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–µ–µ—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                if (loadedReplays[gameId]) {
                    loadedReplays[gameId].isPlaying = false;
                    clearInterval(loadedReplays[gameId].intervalId);
                    const playBtn = document.getElementById(`play-btn-${gameId}`);
                    if (playBtn) playBtn.textContent = 'Play';
                }
            }
        }
        function seekGame(gameId, value) {
            const game = loadedReplays[gameId];
            if (game) {
                game.currentTime = parseInt(value);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
                const timeDisplay = document.getElementById(`time-current-${gameId}`);
                if (timeDisplay) {
                    const mins = Math.floor(game.currentTime / 60000);
                    const secs = Math.floor((game.currentTime % 60000) / 1000);
                    timeDisplay.textContent = mins.toString().padStart(2, '0') + ":" + secs.toString().padStart(2, '0');
                }
                renderReplayFrame(gameId, game.currentTime);
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–π–º–ª–∞–π–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadReplayData(gameId) {
            if (!gameId) return;
            
            try {
                const response = await fetch(`/get_match_replay/${gameId}`);
                const data = await response.json();

                if (data.error) return;

                loadedReplays[gameId] = {
                    timeline: data.timeline || [],
                    events: data.events || [],
                    isPlaying: false,
                    currentTime: 0,
                    maxTime: (data.timeline && data.timeline.length > 0) ? data.timeline[data.timeline.length - 1].timestamp : 0,
                    intervalId: null
                };

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∫–∏ —Å–æ–±—ã—Ç–∏–π
                fillEventLists(gameId, data.events);

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞
                const slider = document.getElementById(`slider-${gameId}`);
                if (slider) slider.max = loadedReplays[gameId].maxTime;

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                const totalMs = loadedReplays[gameId].maxTime;
                const totalTimeElem = document.getElementById(`time-total-${gameId}`);
                if (totalTimeElem) {
                    const mins = Math.floor(totalMs / 60000);
                    const secs = Math.floor((totalMs % 60000) / 1000);
                    totalTimeElem.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }

                renderReplayFrame(gameId, 0);

            } catch (err) {
                console.error("Load error:", err);
            }
        }
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        function fillEventLists(gameId, events) {
            const blueList = document.getElementById(`events-blue-${gameId}`);
            const redList = document.getElementById(`events-red-${gameId}`);
            if (!blueList || !redList) return;

            blueList.innerHTML = '';
            redList.innerHTML = '';

            events.forEach(event => {
                const div = document.createElement('div');
                div.className = 'event-item';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è MM:SS (–∏–∑ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)
                const mins = Math.floor(event.timestamp / 60000);
                const secs = Math.floor((event.timestamp % 60000) / 1000);
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                let icon = "‚öîÔ∏è"; 
                if (event.type.includes('BUILDING')) icon = "üè∞";
                if (event.type.includes('ELITE_MONSTER')) icon = "üê≤";

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º event.text, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∏ –≤ Python —Å –∏–º–µ–Ω–µ–º –∏–≥—Ä–æ–∫–∞
                div.innerHTML = `<span style="color:#ffd700; font-family:monospace;">[${timeStr}]</span> 
                                <span style="margin-left:5px;">${icon} ${event.text || event.message}</span>`;
                
                div.style.cssText = "padding: 5px; border-bottom: 1px solid #222; cursor: pointer; color: #eee; font-size: 0.85em;";
                
                div.onclick = () => {
                    seekGame(gameId, event.timestamp);
                    // –ï—Å–ª–∏ –∏–≥—Ä–∞ —Å—Ç–æ—è–ª–∞ –Ω–∞ –ø–∞—É–∑–µ, –æ–Ω–∞ –æ–±–Ω–æ–≤–∏—Ç –∫–∞–¥—Ä. –ï—Å–ª–∏ –∏–≥—Ä–∞–ª–∞ - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞.
                };

                div.onmouseover = () => div.style.background = "#222";
                div.onmouseout = () => div.style.background = "transparent";

                if (event.teamId === 100) blueList.appendChild(div);
                else redList.appendChild(div);
            });
        }
        let animationId = null;
        let lastTimestamp = 0;

        function animate(timestamp, gameId) {
            const game = loadedReplays[gameId];
            if (!game || !game.isPlaying) return;

            if (!lastTimestamp) lastTimestamp = timestamp;
            const delta = (timestamp - lastTimestamp) * (game.speed || 1);
            lastTimestamp = timestamp;

            game.currentTime += delta;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –º–∞–∫—Å –≤—Ä–µ–º–µ–Ω–∏
            if (game.currentTime > game.maxTime) {
                game.currentTime = 0; // –∏–ª–∏ –ø–∞—É–∑–∞
            }

            const slider = document.getElementById(`slider-${gameId}`);
            if (slider) slider.value = game.currentTime;

            renderReplayFrame(gameId, game.currentTime);
            
            animationId = requestAnimationFrame((t) => animate(t, gameId));
        }

        function togglePlay(element) {
            const gameId = element.id.replace('play-btn-', '');
            const game = loadedReplays[gameId];
            if (!game) return;

            game.isPlaying = !game.isPlaying;

            if (game.isPlaying) {
                element.textContent = 'Pause';
                lastTimestamp = 0;
                animationId = requestAnimationFrame((t) => animate(t, gameId));
            } else {
                element.textContent = 'Play';
                if (animationId) cancelAnimationFrame(animationId);
            }
        }

        function renderReplayFrame(gameId, timeMs) {
            const game = loadedReplays[gameId];
            if (!game || !game.timeline) return;

            // 1. –ù–∞—Ö–æ–¥–∏–º –¥–≤–∞ –∫–∞–¥—Ä–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
            let currentFrame = null;
            let nextFrame = null;

            for (let i = 0; i < game.timeline.length; i++) {
                if (game.timeline[i].timestamp <= timeMs) {
                    currentFrame = game.timeline[i];
                } else {
                    nextFrame = game.timeline[i];
                    break;
                }
            }

            if (!currentFrame) return;

            const mapContainer = document.getElementById(`map-${gameId}`);
            const maxCoord = 15000;

            currentFrame.positions.forEach(p1 => {
                let icon = document.getElementById(`icon-${gameId}-${p1.championName}`);
                
                if (!icon) {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ)
                    icon = document.createElement('img');
                    icon.id = `icon-${gameId}-${p1.championName}`;
                    icon.src = `https://ddragon.leagueoflegends.com/cdn/16.1.1/img/champion/${p1.championName}.png`;
                    icon.style.cssText = `
                        position: absolute; width: 26px; height: 26px; border-radius: 50%; z-index: 10;
                        border: 2px solid ${p1.teamId === 100 ? '#4a90e2' : '#e24a4a'};
                        background: #000; transform: translate(-50%, -50%);
                        transition: left 0.1s linear, top 0.1s linear; /* –ú–∞–ª–µ–Ω—å–∫–∏–π —Ç—Ä–∞–Ω–∑–∏—à–Ω –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è */
                    `;
                    mapContainer.appendChild(icon);
                }

                let posX = p1.x;
                let posZ = p1.z;

                // 2. –í–´–ß–ò–°–õ–Ø–ï–ú –ü–†–û–ú–ï–ñ–£–¢–û–ß–ù–£–Æ –ü–û–ó–ò–¶–ò–Æ (–ú–∞–≥–∏—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏)
                if (nextFrame) {
                    const p2 = nextFrame.positions.find(p => p.championName === p1.championName);
                    if (p2) {
                        // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç t (–æ—Ç 0 –¥–æ 1)
                        const t = (timeMs - currentFrame.timestamp) / (nextFrame.timestamp - currentFrame.timestamp);
                        // –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                        posX = p1.x + (p2.x - p1.x) * t;
                        posZ = p1.z + (p2.z - p1.z) * t;
                    }
                }

                const left = (posX / maxCoord) * 100;
                const top = (1 - (posZ / maxCoord)) * 100;

                icon.style.left = left + '%';
                icon.style.top = top + '%';
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
            const timeDisplay = document.getElementById(`time-current-${gameId}`);
            if (timeDisplay) {
                const mins = Math.floor(timeMs / 60000);
                const secs = Math.floor((timeMs % 60000) / 1000);
                timeDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // --- –¢–≤–æ–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
        function toggleAssets(btn, type) {
            const teamBlock = btn.closest('.team-details');
            const playerList = teamBlock.querySelector('.players-list');
            const eventBox = teamBlock.querySelector('.events-container');
            
            // 1. –ò–≤–µ–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –≤–∏–¥–Ω—ã, –º—ã –∏—Ö –Ω–µ —Ç—Ä–æ–≥–∞–µ–º (—É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å–∫—Ä—ã—Ç–∏—è)
            // playerList.style.display = 'block'; // –í—Å–µ–≥–¥–∞ –±–ª–æ–∫
            // eventBox.style.display = 'block';   // –í—Å–µ–≥–¥–∞ –±–ª–æ–∫

            // 2. –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            teamBlock.querySelectorAll('.items-container, .runes-container, .stats-container').forEach(el => {
                el.style.display = 'none';
            });

            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ç–∏–ø
            if (type === 'items') {
                teamBlock.querySelectorAll('.items-container').forEach(el => el.style.display = 'flex');
            } else if (type === 'runes') {
                teamBlock.querySelectorAll('.runes-container').forEach(el => el.style.display = 'block');
            } else if (type === 'stats') {
                teamBlock.querySelectorAll('.stats-container').forEach(el => el.style.display = 'flex');
            }
            
            // 4. –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
            const buttons = teamBlock.querySelectorAll('.toggle-btns button');
            buttons.forEach(b => {
                b.style.background = '#333';
                b.style.color = b.style.borderColor; 
            });
            btn.style.background = btn.style.borderColor;
            btn.style.color = 'white';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sortableTables = document.querySelectorAll('.sortable-table');
            sortableTables.forEach(table => {
                const headers = table.querySelectorAll('th.sortable-header');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const tableBody = table.querySelector('tbody');
                        const columnIndex = parseInt(header.dataset.sortCol);
                        const sortType = header.dataset.sortType || 'string';
                        const currentIsAscending = header.classList.contains('asc');
                        const direction = currentIsAscending ? -1 : 1;

                        headers.forEach(h => h.classList.remove('asc', 'desc'));
                        header.classList.toggle('asc', !currentIsAscending);
                        header.classList.toggle('desc', currentIsAscending);

                        Array.from(tableBody.querySelectorAll('tr'))
                            .sort((rowA, rowB) => {
                                const cellA = rowA.querySelector(`td:nth-child(${columnIndex + 1})`);
                                const cellB = rowB.querySelector(`td:nth-child(${columnIndex + 1})`);
                                let valueA = cellA.dataset.sortValue || cellA.textContent.trim();
                                let valueB = cellB.dataset.sortValue || cellB.textContent.trim();

                                if (sortType === 'number') {
                                    valueA = parseFloat(valueA) || 0;
                                    valueB = parseFloat(valueB) || 0;
                                } else {
                                    valueA = valueA.toLowerCase();
                                    valueB = valueB.toLowerCase();
                                }

                                if (valueA < valueB) return -1 * direction;
                                if (valueA > valueB) return 1 * direction;
                                return 0;
                            })
                            .forEach(sortedRow => tableBody.appendChild(sortedRow));
                    });
                });
            });
        });
    </script>

{% endblock %}