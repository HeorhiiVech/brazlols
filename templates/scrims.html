{% extends "base.html" %}

{% block title %}Scrim Statistics{% endblock %}

{% block content %}
    <style>
        /* Фон всей скрытой строки */
        .details-row {
            background-color: #2a2a2a;
        }
        /* Контейнер для блоков деталей */
        .match-details-container {
            padding: 15px;
            display: flex;
            justify-content: space-around;
            gap: 20px;
            border-bottom: 2px solid #444; /* Темная граница */
            color: #eee; /* Светлый основной текст */
        }
        /* Блок конкретной команды */
        .team-details {
            flex: 1;
            background: #333; /* Темно-серый фон блока */
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* Более темная тень */
        }
        /* Заголовок команды в деталях */
        .team-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444; /* Темный разделитель */
            color: #eee; /* Светлый текст заголовка */
        }
        
        /* Строка игрока */
        .player-detail-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444; /* Темный разделитель между игроками */
        }
        .player-detail-row:last-child { border-bottom: none; }
        
        .pd-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .pd-name { font-weight: 500; font-size: 0.95em; color: #eee; }
        .pd-champ-name { color: #aaa; font-size: 0.85em; margin-left: 5px;} /* Светло-серый для имени чемпиона */
        .pd-kda { font-family: monospace; font-weight: bold; color: #eee; min-width: 60px; text-align: right;}
        
        /* Центр со счетом */
        .score-summary {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        /* Цвета счета немного осветлены для темного фона */
        .score-blue { color: #4a90e2; }
        .score-red { color: #e74c3c; }

        /* Кнопка Show/Hide */
        .btn-details {
            background: none;
            border: 1px solid #555;
            color: #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-details:hover { background-color: #444; color: #fff; }
    </style>

    <div class="header-controls">
        <h1>Scrim Statistics</h1>
        <div class="controls">
            <form action="{{ url_for('update_scrims_route', time_filter=selected_time_filter, side_filter=selected_side_filter) }}" method="post">
                 {# Передаем текущие фильтры в action, чтобы сохранить их после обновления #}
                <button type="submit" class="button button-update">Update Scrims (Dont click)</button>
            </form>
            <form method="get" class="filter-form">
                 {# Скрытое поле для сохранения фильтра стороны при смене времени #}
                 <input type="hidden" name="side_filter" value="{{ selected_side_filter }}">
                <label for="time_filter">Filter:</label>
                <select name="time_filter" id="time_filter" onchange="this.form.submit()">
                    {% for filter_option in time_filters %}
                        <option value="{{ filter_option }}" {% if filter_option == selected_time_filter %}selected{% endif %}>
                            {{ filter_option }}
                        </option>
                    {% endfor %}
                </select>
                <noscript><button type="submit" class="button">Apply Filter</button></noscript>
            </form>
        </div>
    </div>

    <hr>

    <h2>Overall Statistics ({{ selected_time_filter }})</h2>
    {% if overall_stats and overall_stats.total_games > 0 %}
        <div class="overall-stats-container">
            <div class="stat-card"> {# Total card без доп. класса #}
                <h3>Total</h3>
                <p class="stat-value">{{ overall_stats.total_games }}</p>
                <p class="stat-label">Games</p>
                {% set total_wr = (overall_stats.blue_wins + overall_stats.red_wins) / overall_stats.total_games * 100 if overall_stats.total_games else 0 %}
                <p class="stat-sublabel {{ 'stat-positive' if total_wr >= 50 else 'stat-negative' }}">
                   {{ "%.1f"|format(total_wr) }}% WR
                </p>
                 <small>({{ overall_stats.blue_wins + overall_stats.red_wins }}W - {{ overall_stats.blue_losses + overall_stats.red_losses }}L)</small>
            </div>
             {# Добавляем классы stat-card-blue и stat-card-red #}
            <div class="stat-card stat-card-blue">
                <h3>Blue Side</h3>
                 {% set blue_games = overall_stats.blue_wins + overall_stats.blue_losses %}
                 <p class="stat-value">{{ blue_games }}</p>
                 <p class="stat-label">Games</p>
                 {% set blue_wr = overall_stats.blue_wins / blue_games * 100 if blue_games else 0 %}
                <p class="stat-sublabel {{ 'stat-positive' if blue_wr >= 50 else 'stat-negative' }}">
                    {{ "%.1f"|format(blue_wr) }}% WR
                </p>
                 <small>({{ overall_stats.blue_wins }}W - {{ overall_stats.blue_losses }}L)</small>
            </div>
            <div class="stat-card stat-card-red">
                <h3>Red Side</h3>
                 {% set red_games = overall_stats.red_wins + overall_stats.red_losses %}
                 <p class="stat-value">{{ red_games }}</p>
                 <p class="stat-label">Games</p>
                {% set red_wr = overall_stats.red_wins / red_games * 100 if red_games else 0 %}
                <p class="stat-sublabel {{ 'stat-positive' if red_wr >= 50 else 'stat-negative' }}">
                    {{ "%.1f"|format(red_wr) }}% WR
                </p>
                 <small>({{ overall_stats.red_wins }}W - {{ overall_stats.red_losses }}L)</small>
            </div>
        </div>
    {% else %}
        <p class="notice">No overall statistics available for this period.</p>
    {% endif %}

    <hr>

    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
        <h2>Player Champion Stats ({{ selected_time_filter }})</h2>
        {# НОВЫЕ Кнопки фильтра по стороне #}
        <div class="side-filter-controls">
            <a href="{{ url_for('scrims', time_filter=selected_time_filter, side_filter='all') }}"
               class="button {% if selected_side_filter == 'all' %}active{% endif %}">All</a>
            <a href="{{ url_for('scrims', time_filter=selected_time_filter, side_filter='blue') }}"
               class="button {% if selected_side_filter == 'blue' %}active{% endif %}">Blue Side</a>
            <a href="{{ url_for('scrims', time_filter=selected_time_filter, side_filter='red') }}"
               class="button {% if selected_side_filter == 'red' %}active{% endif %}">Red Side</a>
        </div>
    </div>

    {% if player_stats %}
    <div class="player-stats-grid">
        {% for player_name, champs in player_stats.items() %}
            {% if champs %} {# Показываем колонку только если есть статы для этого игрока с учетом фильтров #}
            <div class="player-column">
                <h3>{{ player_name }}</h3>
                <div class="table-responsive">
                    {# Добавляем id к таблице для JS #}
                    <table class="player-champ-table sortable-table" id="table-{{ player_name }}">
                        <thead>
                            <tr>
                                {# Добавляем классы и data-sort-type к заголовкам для JS #}
                                <th>Icon</th>
                                <th class="sortable-header" data-sort-col="1" data-sort-type="number">G</th>
                                <th class="sortable-header" data-sort-col="2" data-sort-type="number">WR%</th>
                                <th class="sortable-header" data-sort-col="3" data-sort-type="number">KDA</th>
                                <th class="sortable-header" data-sort-col="4" data-sort-type="number">Dmg</th>
                                <th class="sortable-header" data-sort-col="5" data-sort-type="number">CS</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for champ_name, stats in champs.items() %}
                             <tr>
                                <td>{{ stats.icon_html | safe }}</td>
                                <td>{{ stats.games }}</td>
                                <td data-sort-value="{{ stats.win_rate }}" class="
                                    {% if stats.win_rate >= 60 %}wr-high
                                    {% elif stats.win_rate <= 45 %}wr-low
                                    {% else %}wr-mid{% endif %}
                                ">{{ "%.1f"|format(stats.win_rate) }}</td>
                                <td data-sort-value="{{ stats.kda }}">{{ "%.1f"|format(stats.kda) }}</td>
                                <td data-sort-value="{{ stats.avg_dmg }}">{{ stats.avg_dmg }}</td>
                                <td data-sort-value="{{ stats.avg_cs }}">{{ "%.1f"|format(stats.avg_cs) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% else %}
        <p class="notice">No player statistics available for {{ selected_side_filter if selected_side_filter != 'all' else 'this period'}}{% if selected_side_filter != 'all' %} side{% endif %}.</p>
    {% endif %}


    <hr>

    <h2>Game History ({{ selected_time_filter }})</h2>
    {% if history %}
        <div class="table-responsive">
        <table class="scrims-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Patch</th>
                    <th>Blue Team</th>
                    <th>B Bans</th>
                    <th>B Picks</th>
                    <th>R Picks</th>
                    <th>R Bans</th>
                    <th>Red Team</th>
                    <th>Result</th>
                    <th>Duration</th>
                    <th>Details</th> </tr>
            </thead>
            <tbody>
                {% for game in history %}
                <tr>
                    <td class="col-date">{{ game['Date'] }}</td>
                    <td class="col-patch">{{ game['Patch'] }}</td>
                    <td class="col-team">{{ game['Blue_Team_Name'] }}</td>
                    <td class="col-picks-bans">{{ game['B_Bans_HTML'] | safe }}</td>
                    <td class="col-picks-bans">{{ game['B_Picks_HTML'] | safe }}</td>
                    <td class="col-picks-bans">{{ game['R_Picks_HTML'] | safe }}</td>
                    <td class="col-picks-bans">{{ game['R_Bans_HTML'] | safe }}</td>
                    <td class="col-team">{{ game['Red_Team_Name'] }}</td>
                    <td class="col-result result-{{ game['Result'] | lower }}">{{ game['Result'] }}</td>
                    <td class="col-duration">{{ game['Duration'] }}</td>
                    <td>
                        <button class="btn-details" onclick="toggleDetails('details-{{ game.Game_ID }}')">
                            Show
                        </button>
                    </td>
                </tr>
                
                <tr id="details-{{ game.Game_ID }}" class="details-row" style="display: none;">
                    <td colspan="11">
                        <div class="match-details-container" style="padding: 20px; display: flex; flex-direction: column; gap: 15px;">
                            
                            <div style="display: flex; justify-content: space-around; gap: 20px;">
                                
                                <div class="team-details blue-side" style="flex: 1; background: #1a2333; padding: 15px; border-radius: 8px; border-left: 5px solid #4a90e2; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                                    <div class="team-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333;">
                                        <span style="color: #4a90e2; font-weight: bold; font-size: 1.2em;">{{ game.Blue_Team_Name }}</span>
                                        <span style="background: #4a90e2; color: white; padding: 2px 10px; border-radius: 4px; font-size: 1.3em; font-weight: 800;">{{ game.details.blue_total_kills }}</span>
                                    </div>
                                    
                                    {% for p in game.details.blue_players %}
                                    <div class="player-detail-row" style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; gap: 10px;">
                                        <div style="display: flex; align-items: center; width: 160px; flex-shrink: 0;">
                                            <div style="width: 32px; height: 32px; flex-shrink: 0; margin-right: 10px;">{{ p.icon_html | safe }}</div>
                                            <span style="font-size: 0.95em; color: #fff; font-weight: 500;">{{ p.name }}</span>
                                        </div>

                                        <div style="display: flex; gap: 3px; flex-grow: 1; justify-content: center;">
                                            {% if p.items_list %}
                                                {% set items = p.items_list.split(',') if p.items_list is string else p.items_list %}
                                                {% for item_id in items %}
                                                    {% if item_id|string != "0" and item_id|string != "" %}
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/16.1.1/img/item/{{ item_id }}.png" 
                                                            width="22" height="22" style="border-radius: 3px; border: 1px solid #444;">
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>

                                        <div style="width: 100px; text-align: right; font-family: 'Courier New', monospace; font-size: 1.15em; font-weight: 800; letter-spacing: 1px;">
                                            {{ p.k }}/<span style="color: #ff4d4d;">{{ p.d }}</span>/{{ p.a }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="team-details red-side" style="flex: 1; background: #331a1a; padding: 15px; border-radius: 8px; border-right: 5px solid #e24a4a; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                                    <div class="team-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333;">
                                        <span style="background: #e24a4a; color: white; padding: 2px 10px; border-radius: 4px; font-size: 1.3em; font-weight: 800;">{{ game.details.red_total_kills }}</span>
                                        <span style="color: #e24a4a; font-weight: bold; font-size: 1.2em;">{{ game.Red_Team_Name }}</span>
                                    </div>

                                    {% for p in game.details.red_players %}
                                    <div class="player-detail-row" style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; gap: 10px;">
                                        <div style="display: flex; align-items: center; width: 160px; flex-shrink: 0;">
                                            <div style="width: 32px; height: 32px; flex-shrink: 0; margin-right: 10px;">{{ p.icon_html | safe }}</div>
                                            <span style="font-size: 0.95em; color: #fff; font-weight: 500;">{{ p.name }}</span>
                                        </div>

                                        <div style="display: flex; gap: 3px; flex-grow: 1; justify-content: center;">
                                            {% if p.items_list %}
                                                {% set items = p.items_list.split(',') if p.items_list is string else p.items_list %}
                                                {% for item_id in items %}
                                                    {% if item_id|string != "0" and item_id|string != "" %}
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/16.1.1/img/item/{{ item_id }}.png" 
                                                            width="22" height="22" style="border-radius: 3px; border: 1px solid #444;">
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>

                                        <div style="width: 100px; text-align: right; font-family: 'Courier New', monospace; font-size: 1.15em; font-weight: 800; letter-spacing: 1px;">
                                            {{ p.k }}/<span style="color: #ff4d4d;">{{ p.d }}</span>/{{ p.a }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 10px;">
                                <div class="col-result result-{{ game['Result'] | lower }}" style="display: inline-block; padding: 8px 25px; border-radius: 6px; font-weight: bold; font-size: 1.1em; text-transform: uppercase; letter-spacing: 1px;">
                                    {{ game['Result'] }}
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="notice">No game history available for this period.</p>
    {% endif %}

    {# --- НОВЫЙ Блок JavaScript для сортировки и переключения деталей --- #}
    <script>
        // Функция для переключения видимости деталей
        function toggleDetails(rowId) {
            const row = document.getElementById(rowId);
            const btn = row.previousElementSibling.querySelector('.btn-details');
            if (row.style.display === 'none') {
                row.style.display = 'table-row';
                btn.textContent = 'Hide';
            } else {
                row.style.display = 'none';
                btn.textContent = 'Show';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sortableTables = document.querySelectorAll('.sortable-table');

            sortableTables.forEach(table => {
                const headers = table.querySelectorAll('th.sortable-header');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const tableBody = table.querySelector('tbody');
                        const columnIndex = parseInt(header.dataset.sortCol);
                        const sortType = header.dataset.sortType || 'string'; // 'number' or 'string'
                        const currentIsAscending = header.classList.contains('asc');
                        const direction = currentIsAscending ? -1 : 1; // -1 for desc, 1 for asc

                        // Remove sorting classes from other headers
                        headers.forEach(h => h.classList.remove('asc', 'desc'));
                        // Add appropriate class to current header
                        header.classList.toggle('asc', !currentIsAscending);
                        header.classList.toggle('desc', currentIsAscending);

                        // Sort rows
                        Array.from(tableBody.querySelectorAll('tr'))
                            .sort((rowA, rowB) => {
                                const cellA = rowA.querySelector(`td:nth-child(${columnIndex + 1})`);
                                const cellB = rowB.querySelector(`td:nth-child(${columnIndex + 1})`);

                                let valueA = cellA.dataset.sortValue || cellA.textContent.trim();
                                let valueB = cellB.dataset.sortValue || cellB.textContent.trim();

                                if (sortType === 'number') {
                                    valueA = parseFloat(valueA) || 0;
                                    valueB = parseFloat(valueB) || 0;
                                } else {
                                    valueA = valueA.toLowerCase();
                                    valueB = valueB.toLowerCase();
                                }

                                if (valueA < valueB) return -1 * direction;
                                if (valueA > valueB) return 1 * direction;
                                return 0;
                            })
                            .forEach(sortedRow => tableBody.appendChild(sortedRow)); // Append rows in sorted order
                    });
                });
            });
        });
    </script>

{% endblock %}